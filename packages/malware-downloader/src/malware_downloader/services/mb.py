import io
import zipfile
from pathlib import Path
from tempfile import NamedTemporaryFile

from common.logger import get_logger
from malware_downloader.utils.utils import shorten
from malware_downloader.utils.wrappers import ratelimiter, save_to, skip_if
from malwarebazaar import Bazaar

MB_METADATA = "malwarebazaar.json"
MB_RATELIMITS = {
    "daily": (2_000, 86_400),
}

_client = None
mb_ratelimit_min = ratelimiter(*MB_RATELIMITS["daily"])
logger = get_logger(__name__)


def set_apikey(apikey: str):
    global _client
    _client = Bazaar(apikey)


def get_client():
    return _client


@mb_ratelimit_min
@skip_if(lambda hash, path: Path(path).joinpath(hash, f"{hash}.zip").exists())
@save_to(lambda hash, path: Path(path).joinpath(hash, f"{hash}.zip"))
def download_sample(hash: str, path: Path):
    logger.info(f"Retrieving file for {shorten(hash)}")
    data = _client.download_file(hash)

    if not data or not zipfile.is_zipfile(io.BytesIO(data)):
        raise FileNotFoundError(
            f"Sample not found or invalid format for hash {shorten(hash)}"
        )

    with NamedTemporaryFile(delete=False) as tmp:
        tmp.write(data)
        return str(tmp.name)


@skip_if(lambda hash, path: Path(path).joinpath(hash, MB_METADATA).exists())
@save_to(lambda hash, path: Path(path).joinpath(hash, MB_METADATA))
def download_metadata(hash: str, path: Path):
    logger.info(f"Retrieving metadata for {shorten(hash)}")
    response = _client.query_hash(hash)

    if response.get("query_status") == "ok":
        return response

    raise RuntimeError(
        f"Failed to retrieve metadata for {shorten(hash)}: "
        f"query_status='{response.get('query_status')}'"
    )