import inspect
import itertools
from typing import Annotated

import malware_downloader.services.vt as svc
import typer
from common.callbacks import verbose_callback
from common.logger import get_logger
from malware_downloader.utils.callbacks import apikey_callback, hashes_callback
from malware_downloader.utils.utils import run_operation

logger = get_logger(__name__)
app = typer.Typer(no_args_is_help=True, pretty_exceptions_show_locals=False)


@app.command()
def download(
    ctx: typer.Context,
    hashes: Annotated[
        str,
        typer.Option(
            callback=hashes_callback,
            help="Comma-separated list of hashes or a file path.",
        ),
    ],
    apikey: Annotated[
        str,
        typer.Option(
            callback=apikey_callback,
            envvar=["VT_API_KEY", "API_KEY"],
            prompt=True,
            hide_input=True,
            help="MalwareBazaar API key.",
        ),
    ],
    sample: Annotated[
        bool, typer.Option(help="Download the sample from VirusTotal.")
    ] = False,
    metadata: Annotated[
        bool, typer.Option(help="Download metadata from VirusTotal.")
    ] = False,
    all_behaviours: Annotated[
        bool, typer.Option(help="Download all behavior analysis from VirusTotal.")
    ] = False,
    behavior_summary: Annotated[
        bool, typer.Option(help="Download behavior summary analysis from VirusTotal.")
    ] = False,
    mitre_attack: Annotated[
        bool, typer.Option(help="Download MITRE ATT&CK mapping from VirusTotal.")
    ] = False,
    jujubox_full_report: Annotated[
        bool, typer.Option(help="Download full JujuBox report.")
    ] = False,
    cape_full_report: Annotated[
        bool, typer.Option(help="Download full CAPE report.")
    ] = False,
    output: Annotated[str, typer.Option(help="")] = "output",
    verbose: Annotated[
        int, typer.Option("--verbose", "-v", count=True, callback=verbose_callback)
    ] = 0,
):
    """Download data from VirusTotal for one or more hashes."""
    logger.debug(f"Download command invoked with {len(hashes)} hashes")
    logger.debug(f"Output directory set to: '{output}'")

    selected_ops = [
        fn
        for name, fn in inspect.getmembers(svc, inspect.isfunction)
        if name.startswith("download_")
        and ctx.params.get(name.removeprefix("download_"))
    ]

    try:
        for h, op in itertools.product(hashes, selected_ops):
            run_operation(op, h, output)
    finally:
        logger.debug("Closing VirusTotal API client session")
        svc.get_client().close()
